---
import { XMLParser } from 'fast-xml-parser';

interface BlogPost {
  title: string;
  link: string;
  published: string;
  summary: string;
  imageUrl: string | null;
}

let latestPosts: BlogPost[] = [];
const placeholderImage = "https://placehold.co/600x400/1a202c/4a5568?text=Blog+Post";

try {
  const response = await fetch(
    'https://theabhisheksrivastav.blogspot.com/feeds/posts/default?alt=rss'
  );
  if (!response.ok) throw new Error(`Failed to fetch RSS feed: ${response.statusText}`);

  const xmlText = await response.text();
  const parser = new XMLParser({ ignoreAttributes: false, attributeNamePrefix: "@_" });
  const jsonObj = parser.parse(xmlText);
  const items = jsonObj.rss.channel.item;

  if (Array.isArray(items)) {
    latestPosts = items
      .map((item: any) => {
        const description = item['media:group']?.['media:description']?.['#text'] 
          || item.description 
          || '';

        const imageUrlMatch = description.match(/<img[^>]+src="([^">]+)"/);
        const imageUrl = imageUrlMatch ? imageUrlMatch[1] : placeholderImage;

        const summary = description.replace(/<[^>]*>/g, '').substring(0, 150) + '...';

        return {
          title: item.title,
          link: typeof item.link === 'object' ? item.link['@_href'] : item.link,
          published: new Date(item.pubDate).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
          }),
          summary,
          imageUrl,
        };
      })
      .slice(0, 3);
  }
} catch (error) {
  console.error("Error fetching or parsing blog posts:", error);
}
---

<style>
  .blog-card-image {
    aspect-ratio: 16 / 9;
    object-fit: cover;
  }
</style>

<section id="latest-blog-posts" class="py-16 px-6 md:px-20 bg-[var(--layout-background)] text-[var(--text-primary)]">
  <div class="max-w-6xl mx-auto">
    <!-- Section Header -->
    <div class="flex items-center mb-10">
      <span class="w-3 h-10 bg-[var(--accent-primary)] mr-4 rounded"></span>
      <h2 class="text-3xl md:text-4xl font-bold">Latest Blog Posts</h2>
    </div>

    <!-- Grid for Blog Post Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {latestPosts.length > 0 ? (
        latestPosts.map(post => (
          <a
            href={post.link}
            target="_blank"
            rel="noopener noreferrer"
            class="block bg-[var(--layout-accent)] rounded-2xl overflow-hidden shadow-lg hover:shadow-[var(--accent-primary)]/30 hover:-translate-y-2 transition-all duration-300 group"
            aria-label={`Read more about ${post.title}`}
          >
            <img 
              src={post.imageUrl ?? placeholderImage}
              alt={`Thumbnail for ${post.title}`} 
              class="w-full blog-card-image"
              onerror={`this.onerror=null;this.src='${placeholderImage}';`}
            />
            <div class="p-6 flex flex-col h-full">
              <h3 class="text-xl font-bold mb-3 text-[var(--text-primary)]">{post.title}</h3>
              <p class="opacity-80 text-sm flex-grow">{post.summary}</p>
              <div class="mt-4">
                <span class="text-[var(--accent-primary)] font-semibold opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  Read more â†’
                </span>
                <p class="text-xs mt-2 opacity-60">Published on {post.published}</p>
              </div>
            </div>
          </a>
        ))
      ) : (
        <p class="opacity-70 col-span-full">Could not load blog posts at this time. Please try again later.</p>
      )}
    </div>
    <div class="flex justify-center mt-8">
  <a href="#contact" class="flex items-center justify-center px-6 py-3 bg-[var(--accent-primary)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary)] hover:text-[var(--color-secondary)] transition gap-2">
    <i class="fa-regular fa-circle-right"></i>
    Blogs & Articles
  </a>
</div>
  </div>
</section>
